---
name: code-review
description: 複数のレビュアー（サブエージェント + Codex）を使ってコードレビューを実施し、結果を批判的に検討して修正する。
---

# コードレビュー

複数の視点からコードレビューを実施し、批判的に検討した上で修正を行う。

## 手順

### 1. 並列レビューの実施

以下の2つのレビュアーを**並列で**起動する：

1. **Exploreサブエージェント** - コード品質・セキュリティ観点のレビュー
   - 具体的な行番号付きの指摘
   - Critical/High/Medium/Low の優先度分類

2. **Codex MCP**（利用可能な場合） - 同様の観点でレビュー依頼
   - ファイル位置の明示
   - 簡潔で的確な指摘
   - **注意**: Codex MCPが応答しないことがある。その場合はサブエージェントのレビューのみで進める

### 2. 結果の統合

両レビュアーの結果を `docs/review.md` に統合する：

```markdown
# Code Review Results

## Critical
- [両者が指摘] 問題の説明...
- [サブエージェントのみ] ...
- [Codexのみ] ...

## High
...

## Medium
...

## Low
...
```

### 3. 批判的検討

各指摘について以下を検討する：

- **本当に問題か？** - 誤認や過剰な指摘ではないか
- **修正コストと効果** - 大規模な設計変更が必要か、簡単な修正で済むか
- **既に対応済みではないか** - レビュアーが見落としている可能性

**具体的な検証方法（必ず実施）：**

```bash
# 「〜が実装されていない」→ 実際にコードをgrepして確認
grep -r "authMiddleware" packages/backend/src/

# 「ファイルがGitに混入」→ git ls-filesで確認
git ls-files | grep ".dev.vars"

# 「〜の検証がない」→ 該当コードを読んで確認
# Read ツールで該当ファイルを確認
```

**過去の誤検出例：**
- Codexが「認証の欠如」を指摘 → 実際はOAuth実装済みだった
- Codexが「JWT exp検証がない」と指摘 → hono/jwtは自動でexp検証する
- 攻撃者エージェントが「.dev.varsがGitに混入」→ .gitignoreに入っていて混入していなかった

### 4. 修正の実施

- **Critical/High** → 原則として修正する
- **Medium** → ユーザーに確認してから判断
- **Low** → 時間があれば対応、または別タスクとして残す

### 5. 検証

修正後、以下を実行して問題がないことを確認：

```bash
pnpm typecheck
pnpm test
```

## 注意事項

- レビュー結果を鵜呑みにしない。AIレビュアーは時々間違える
- 両者が同じ問題を指摘していれば信頼性が高い
- 片方だけが指摘している問題は特に慎重に検討する
- 「レート制限にDurable Objectsを使うべき」のような過剰な提案は見送ってよい

## 評価結果が古い/不正確なケース

サブエージェントやCodexの評価結果は、以下の理由で不正確なことがある：

1. **「未使用」が実際は使用中**: 「useModalManagerが未使用」→ 実際はMainApp.tsxで使用済みだった
2. **nullable/optionalの「問題」が意図的な設計**:
   - `optional()`: 入力時に省略可能
   - `nullable()`: DBから取得時にnullの可能性
   - 用途が異なるので混在は問題ではない場合がある
3. **評価時点と現在のコードの乖離**: セッション中にコードが変わっている可能性

**必ず実際のコードを読んで確認してからレビュー結果を採用する。**
