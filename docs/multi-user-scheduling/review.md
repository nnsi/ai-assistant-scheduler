# マルチユーザーカレンダー共有 設計レビュー結果

レビュー実施日: 2026-01-08

## レビュアー
- Explore サブエージェント（コード品質・設計観点）
- セキュリティレビュアー（セキュリティ観点）

---

## Critical

### 1. 認可ミドルウェアの統合方法が未定義
**指摘元**: 両者
**問題**: 設計では権限モデル（owner/admin/editor/viewer）を定義しているが、既存の`authMiddleware`とどう統合するか具体的な実装指針がない。

**検証結果**: 既存の`authMiddleware`は`userId`の設定のみで、カレンダー権限チェックの仕組みがない。設計への追記が必要。

**対応**: 設計に`calendarAuthMiddleware`の実装パターンを追記

---

### 2. schedulesにcreated_byフィールドが不足
**指摘元**: 両者
**問題**: 設計の権限マトリクスで「editorは自分が作成したスケジュールのみ編集可能」としているが、現在のスキーマに`created_by`がなく実装不可能。

**検証結果**: 既存スキーマを確認、`created_by`フィールドは存在しない。
```bash
grep -n "created_by" packages/backend/src/infra/drizzle/schema.ts
# → 該当なし
```

**対応**: スキーマ設計に`created_by`カラムを追加

---

### 3. 招待トークン・公開トークンの生成方法が未指定
**指摘元**: 両者
**問題**: トークンの具体的な生成アルゴリズム、エントロピー、ハッシュ化の有無が未定義。

**検証結果**: 設計では「32文字以上のランダム文字列」とあるが、具体的な実装指針がない。

**対応**: トークン生成ユーティリティの仕様を追記（nanoid(32)推奨）

---

### 4. マイグレーション戦略が不完全
**指摘元**: Explore
**問題**: Phase 2のデータマイグレーション（既存データへのcalendar_id設定）がアプリケーションレベルで必要だが、具体的な実装場所・方法が未定義。

**検証結果**: 既存マイグレーションは全てSQL-onlyで、アプリケーションレベルのマイグレーション仕組みがない。

**対応**: マイグレーションスクリプトの具体的な実装方針を追記

---

## High

### 5. 公開カレンダーの情報漏洩リスク
**指摘元**: セキュリティレビュアー
**問題**: 公開カレンダーでスケジュールの詳細（タイトル等）がすべて公開される。機密情報を含む可能性。

**検証結果**: 妥当な指摘。公開カレンダーの仕様として考慮が必要。

**対応**: 設計に「予定あり」のみ表示するオプションを追加検討。ただし、これはMVPではなくフェーズ2以降の機能とする。

---

### 6. admin権限付与の制限が不十分
**指摘元**: セキュリティレビュアー
**問題**: 招待リンクではviewer/editorのみ許可しているが、直接メンバー追加ではadminも許可。admin権限の付与はownerのみに制限すべき。

**検証結果**: 設計の権限マトリクスでは「adminはメンバー招待可能」となっている。admin→adminの昇格を防ぐロジックが必要。

**対応**: 設計に「admin権限付与はownerのみ」の制約を追記

---

### 7. IDORリスク（メンバー管理API）
**指摘元**: セキュリティレビュアー
**問題**: `PUT /calendars/:id/members/:uid`で、calendar_idとuser_idの複合チェックが必要。

**検証結果**: 既存実装では`findByIdAndUserId`パターンを使用している。同様のパターンを適用すべき。

**対応**: API設計に複合チェックの必要性を明記

---

### 8. 招待リンク使用時のレースコンディション
**指摘元**: セキュリティレビュアー
**問題**: `use_count`のインクリメントが競合し、`max_uses`を超える可能性。

**検証結果**: D1はトランザクションをサポートするため、原子的な更新で対応可能。

**対応**: 設計に原子的UPDATE文の使用を明記

---

### 9. カスケード削除のデータ損失リスク
**指摘元**: Explore
**問題**: `ON DELETE CASCADE`でカレンダー削除時に全スケジュールが削除される。復元不可。

**検証結果**: 妥当な指摘。ソフトデリートの検討が必要。

**対応**: ソフトデリート（`deleted_at`）の導入を設計に追記

---

### 10. 公開カレンダーAPIにレート制限がない
**指摘元**: セキュリティレビュアー
**問題**: 認証不要の公開エンドポイントにレート制限がない。トークン総当たり・DoS攻撃のリスク。

**検証結果**: 既存の`rateLimit.ts`は認証エンドポイント向け。公開API用の別途対応が必要。

**対応**: IPベースレート制限の追加を設計に明記

---

## Medium

### 11. データベースインデックスが未定義
**指摘元**: Explore
**問題**: `calendar_members`等のテーブルにインデックス定義がない。

**検証結果**: 妥当な指摘。パフォーマンス向上のため必要。

**対応**: 設計にインデックス定義を追記

---

### 12. メンバー招待フローの曖昧さ
**指摘元**: Explore
**問題**: メールアドレス招待とリンク招待の2つのフローがあるが、それぞれの処理の違いが不明確。

**検証結果**: 設計を見返すと確かに曖昧。明確化が必要。

**対応**: 2つのフローの違いを設計に明記

---

### 13. publicUrlの生成方法が未定義
**指摘元**: Explore
**問題**: `publicUrl`フィールドの生成方法（フルURL vs パス）が不明確。

**検証結果**: 既存コードに`FRONTEND_URL`環境変数があるため、それを使用する方針を明記すべき。

**対応**: 設計にURL生成方法を追記

---

### 14. 招待リンク一覧でトークン露出
**指摘元**: セキュリティレビュアー
**問題**: 一覧取得時に完全なトークンを返すとログ等で漏洩リスク。

**検証結果**: 妥当な指摘。マスク表示を検討。

**対応**: 一覧APIではトークンをマスク、作成時のみ完全版を返す設計に変更

---

## Low

### 15. APIエンドポイントの一貫性
**指摘元**: Explore
**問題**: 招待リンクの削除が`/invitations/:token`だが、他は`/calendars/:id/...`パターン。

**検証結果**: 軽微な問題。現状でも問題なく動作する。

**対応**: 設計はこのままで良い（トークンでの直接アクセスが自然）

---

### 16. 監査ログの実装
**指摘元**: 両者
**問題**: メンバー変更等の監査ログが未実装。

**検証結果**: 設計では「将来実装」としている。

**対応**: 現状維持（Phase 2以降で検討）

---

### 17. オーナー離脱時の処理
**指摘元**: セキュリティレビュアー
**問題**: オーナーが離脱を試みた際のエラーハンドリングが未定義。

**検証結果**: 設計の権限マトリクスでは「オーナーは離脱不可」。エラーメッセージの追加で対応可能。

**対応**: エラーメッセージの例を設計に追記

---

## 対応方針まとめ

| 優先度 | 項目 | 対応 |
|--------|------|------|
| Critical | 認可ミドルウェア | 設計に追記 |
| Critical | created_byフィールド | スキーマに追加 |
| Critical | トークン生成 | 仕様を追記 |
| Critical | マイグレーション | 実装方針を追記 |
| High | 公開カレンダー情報漏洩 | Phase 2で対応 |
| High | admin権限付与制限 | 設計に追記 |
| High | IDORリスク | 設計に明記 |
| High | レースコンディション | 原子的更新を明記 |
| High | カスケード削除 | ソフトデリート検討 |
| High | 公開APIレート制限 | 設計に追記 |
| Medium | インデックス | 設計に追記 |
| Medium | 招待フロー明確化 | 設計に追記 |
| Medium | publicURL生成 | 設計に追記 |
| Medium | トークンマスク | 設計に追記 |
| Low | APIエンドポイント | 現状維持 |
| Low | 監査ログ | Phase 2以降 |
| Low | オーナー離脱 | エラー例追記 |
