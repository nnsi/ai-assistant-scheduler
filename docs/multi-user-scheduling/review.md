# マルチユーザーカレンダー共有 設計レビュー結果

レビュー実施日: 2026-01-08（第3回）

## レビュアー
- Explore サブエージェント（コード品質・設計観点）
- セキュリティレビュアー（セキュリティ観点）

---

## 第2回レビュー指摘事項の修正確認

| 指摘 | 状態 |
|------|------|
| ownerロール不整合 | ✅ 修正済み（calendars.owner_idで判定） |
| created_by移行 | ✅ 修正済み（説明を明記） |
| max_uses制約 | ✅ 修正済み（CHECK制約追加） |
| calendarId後方互換性 | ✅ 修正済み（オプショナル化） |
| 公開カレンダー関連 | ✅ 機能削除により解消 |
| ソフトデリートチェック | ✅ 修正済み（ミドルウェアに追加） |
| カテゴリスコープ | ✅ 修正済み（説明を追加） |
| オーナー移譲API | ✅ 修正済み（API追加） |
| トークン表示ガイドライン | ✅ 修正済み（スキーマ明確化） |
| expires_atインデックス | ✅ 修正済み（追加） |
| 繰り返しルール連携 | ✅ 対応済み（設計で対応済み） |

---

## 第3回レビュー指摘事項

### High

#### 1. tasks.mdに公開カレンダータスクが残存
**指摘元**: Explore
**問題**: 設計から公開カレンダー機能を削除したが、tasks.mdにセクション4.3、7.3、E2Eテスト項目が残っている。

**対応**: ✅ 修正済み - 公開カレンダー関連タスクを全て削除

---

#### 2. オーナー移譲APIタスクが不足
**指摘元**: Explore
**問題**: design.mdに`PUT /calendars/:id/transfer`が追加されているが、tasks.mdに対応するタスクがない。

**対応**: ✅ 修正済み - TransferOwnershipUseCase と PUT /calendars/:id/transfer を追加

---

#### 3. 招待リンク受諾API（POST /invitations/:token/accept）の認証要件が不明
**指摘元**: セキュリティレビュアー
**問題**: 招待リンク受諾時に認証が必要かどうかが明記されていない。

**対応**: ✅ 修正済み - 認証必須を明記、認証・認可要件テーブルを追加

---

#### 4. DELETE /invitations/:tokenの認可範囲が不明
**指摘元**: セキュリティレビュアー
**問題**: 招待リンク削除時、誰がどの招待を削除できるかが不明確。IDOR脆弱性のリスク。

**対応**: ✅ 修正済み
- エンドポイントを`DELETE /calendars/:id/invitations/:id`に変更
- admin以上の権限が必要、かつ該当カレンダーの招待のみ削除可能に限定

---

### Medium

#### 5. 招待トークンの平文保存
**指摘元**: セキュリティレビュアー
**問題**: 招待トークンがDB に平文で保存されている。ハッシュ化すべきでは？

**検証結果**: 招待トークンは以下の理由で平文保存を許容:
- nanoid(32)で192ビットのエントロピー（ブルートフォース困難）
- 一時的な性質（有効期限あり、使用回数制限あり）
- URLで送信されるため、ハッシュ化しても照合時に元のトークンが必要
- セッショントークンとは異なり、長期保存されない

**対応**: 現状維持（レート制限で追加保護）

---

## 対応方針まとめ

| 優先度 | 項目 | 対応 |
|--------|------|------|
| High | tasks.md公開カレンダー残存 | ✅ 削除完了 |
| High | オーナー移譲タスク不足 | ✅ 追加完了 |
| High | 招待受諾API認証要件 | ✅ 明記完了 |
| High | 招待削除APIの認可範囲 | ✅ エンドポイント変更 |
| Medium | 招待トークン平文保存 | 現状維持（許容範囲） |

---

## 全レビュー履歴

### 第1回（2026-01-08）
- calendarAuthMiddlewareの実装パターン追加
- schedulesにcreated_byフィールド追加
- calendarsにdeleted_at追加
- トークン生成仕様（nanoid(32)）追加
- IDOR対策・レースコンディション対策追加

### 第2回（2026-01-08）
- ownerロール判定をcalendars.owner_idに統一
- CHECK制約追加
- オーナー移譲API追加
- 招待リンクトークン表示のマスク仕様明確化

### 第3回（2026-01-08）
- 公開カレンダー機能削除後のtasks.md同期
- 招待API認証・認可要件の明確化
- DELETEエンドポイントのIDOR対策
