# マルチユーザーカレンダー共有 設計レビュー結果

レビュー実施日: 2026-01-08（第2回）

## レビュアー
- Explore サブエージェント（コード品質・設計観点）
- セキュリティレビュアー（セキュリティ観点）

---

## 前回の指摘事項の修正確認

| 指摘 | 状態 |
|------|------|
| トークンエントロピー不足 | ✅ 修正済み（nanoid(32)） |
| admin権限付与制限 | ✅ 修正済み（ownerのみ） |
| IDORリスク | ✅ 修正済み（複合チェック） |
| レースコンディション | ✅ 修正済み（原子的UPDATE） |
| 公開APIレート制限 | ✅ 修正済み（IPベース） |
| 公開カレンダー情報漏洩 | ⚠️ 部分的（レスポンス範囲未定義） |

---

## Critical

### 1. ownerロールの扱いが不整合
**指摘元**: Explore
**問題**:
- calendar_membersテーブルのroleは `'viewer' | 'editor' | 'admin'` と定義
- しかし権限マトリクスには`owner`が存在
- マイグレーションスクリプトでは`role: "owner"`を挿入しようとしている

**検証結果**: 確認したところ設計に不整合がある。calendar_membersにownerを入れるか、calendars.owner_idで判定するかを統一する必要がある。

**対応**:
- Option B採用: ownerはcalendars.owner_idで判定、calendar_membersには入れない
- calendar_membersのroleは `'admin' | 'editor' | 'viewer'` のみ
- 権限チェック時にまずowner_idをチェックし、該当しなければcalendar_membersをチェック

---

### 2. マイグレーションでcreated_by情報が失われる
**指摘元**: Explore
**問題**: Phase 2マイグレーションで既存スケジュールのcreated_byをuser_idに設定しているが、共有カレンダー導入後は「誰が作成したか」が重要になる。既存データでは元の作成者情報がないためuser_idを代用するのは妥当だが、これを明記すべき。

**検証結果**: 妥当な指摘。設計に明記が必要。

**対応**: マイグレーション説明に「既存スケジュールはcreated_by = user_id（オーナー）として移行」を明記

---

### 3. calendar_invitationsにmax_uses制約がない
**指摘元**: Explore
**問題**: use_count > max_usesになる可能性がある（理論的には原子的UPDATEで防げるが、DB制約として持つべき）

**検証結果**: 原子的UPDATEで防いでいるが、制約があるとより安全。

**対応**: CHECK制約を追加 `CHECK (max_uses IS NULL OR use_count <= max_uses)`

---

## High

### 4. POST /schedulesのcalendarId必須化と後方互換性
**指摘元**: Explore
**問題**: 設計で「calendarIdを必須に」と書いているが、既存クライアントが破壊される。一方で「省略時はデフォルトカレンダー」とも書いてあり矛盾。

**検証結果**: 矛盾を解消する必要がある。

**対応**: calendarIdはオプショナル、省略時はデフォルトカレンダーを使用することを明確化

---

### 5. 公開カレンダーのレスポンス範囲が未定義
**指摘元**: セキュリティレビュアー
**問題**: `GET /public/:token/schedules`で返却される情報にcreated_byのユーザー情報（名前、メール）が含まれると情報漏洩。

**検証結果**: 妥当な指摘。公開用の限定レスポンススキーマが必要。

**対応**: 公開カレンダー用のレスポンススキーマを追加（個人情報を除外）

---

### 6. ソフトデリート済みカレンダーへのアクセス制御
**指摘元**: セキュリティレビュアー
**問題**: deleted_atがあるカレンダーへのアクセスを拒否する記載がない。

**検証結果**: calendarAuthMiddlewareでdeleted_atチェックを追加すべき。

**対応**: ミドルウェアにソフトデリートチェックを追加

---

### 7. 公開トークンのライフサイクル管理
**指摘元**: セキュリティレビュアー
**問題**: is_publicを無効→再有効化した際のトークン管理方針が不明。

**検証結果**: 妥当な指摘。URLを無効化したい場合の対応が必要。

**対応**: 公開無効化時にpublic_tokenをNULLに、再有効化時に新規生成する方針を明記

---

### 8. カテゴリのスコープが曖昧
**指摘元**: Explore
**問題**: カテゴリがカレンダースコープになるが、既存のuser_idとの関係が不明確。

**検証結果**: カテゴリはカレンダーに紐づくべき。既存カテゴリはデフォルトカレンダーに移行。

**対応**: カテゴリのスコープ変更を明確化

---

## Medium

### 9. オーナー移譲APIがない
**指摘元**: セキュリティレビュアー
**問題**: 「オーナー離脱不可、先にオーナー移譲が必要」とあるが、移譲APIがない。

**対応**: `PUT /calendars/:id/transfer-ownership` を追加

---

### 10. 招待リンク一覧のトークン表示
**指摘元**: セキュリティレビュアー
**問題**: 生成時は完全トークン、一覧時はマスク表示の実装ガイドラインが不明確。

**対応**: レスポンススキーマを明確化（token vs tokenPreview）

---

### 11. レート制限のCloudflare Workers対応
**指摘元**: Explore
**問題**: Cloudflare Workersでは通常のIPベースレート制限が難しい。

**検証結果**: Cloudflare Rate Limiting製品またはDurable Objectsを使用すべきだが、過剰な提案。初期実装ではシンプルな方法で対応可能。

**対応**: 現状維持（実装フェーズで検討）

---

### 12. RETURNING句のSQLite/D1互換性
**指摘元**: Explore
**問題**: RETURNING句はSQLite 3.35+が必要。D1でのサポート確認が必要。

**対応**: 実装時に確認、必要なら2段階クエリに変更

---

## Low

### 13. インデックス追加
**指摘元**: Explore
**問題**: expires_atへのインデックスがない（クリーンアップクエリ用）

**対応**: インデックスを追加

---

### 14. 繰り返しルールとの連携
**指摘元**: Explore
**問題**: 繰り返しスケジュールと共有カレンダーの連携が未記載。

**対応**: 繰り返しはスケジュールに紐づくため、calendar_id経由で自動的に共有される旨を明記

---

## 対応方針まとめ

| 優先度 | 項目 | 対応 |
|--------|------|------|
| Critical | ownerロール不整合 | calendars.owner_idで判定に統一 |
| Critical | created_by移行 | 説明を明記 |
| Critical | max_uses制約 | CHECK制約追加 |
| High | calendarId後方互換性 | オプショナルに修正 |
| High | 公開レスポンス範囲 | スキーマ追加 |
| High | ソフトデリートチェック | ミドルウェアに追加 |
| High | 公開トークンライフサイクル | 方針を明記 |
| High | カテゴリスコープ | 説明を追加 |
| Medium | オーナー移譲API | API追加 |
| Medium | トークン表示ガイドライン | スキーマ明確化 |
| Low | expires_atインデックス | 追加 |
| Low | 繰り返しルール連携 | 説明追加 |
