# モバイル版 機能実装タスク

**ゴール**: Webで出来ることは全てMobileでも出来るようにする

基準ドキュメント: [/docs/mobile.md](./mobile.md)、[/docs/web.md](./web.md)

---

## 1. 予定フォームの拡張

### 1.1 メモ機能
- [x] ScheduleFormにメモ入力フィールドを追加
- [x] 予定作成時にメモを保存
- [x] 予定編集時にメモを表示・更新

### 1.2 繰り返し設定
- [x] ScheduleFormに繰り返し設定チェックボックスを追加
- [x] 繰り返しルール選択UI（毎日/毎週/毎月など）
- [x] useRecurrence hookをmobileで使用

---

## 2. 予定詳細の完全表示

### 2.1 詳細情報の表示
- [x] カテゴリ表示（色付きラベル）
- [x] メモ表示セクション
- [x] AI検索結果表示（「AI検索結果を表示」展開）

### 2.2 アクションボタン
- [x] AI再検索ボタン
- [x] 削除前の確認ダイアログ追加

---

## 3. AI検索機能

### 3.1 AIで補完ボタン
- [x] ScheduleFormに「AIで補完」ボタンを追加
- [x] useAI hookをmobileで使用

### 3.2 キーワード選択画面
- [x] キーワード選択モーダルの実装
- [x] 60+キーワードのグリッド表示
- [x] 選択状態の管理（複数選択）
- [x] 「別のキーワードを提案してもらう」ボタン
- [x] 「スキップ」ボタン
- [x] 「検索する (N件選択中)」ボタン

### 3.3 検索結果表示
- [x] 検索結果モーダルの実装
- [x] 店舗情報表示（店舗名、説明、営業時間、アクセス）
- [x] 条件判定表示（必須条件✅、優先条件✅、重視ポイント△）
- [x] 外部リンク（ぐるなび、食べログ）
- [x] 「取得中...」ローディング表示
- [x] 「中断して閉じる」ボタン

---

## 4. こだわり条件設定

- [x] こだわり条件設定モーダルの実装
- [x] 必須条件入力フィールド
- [x] 優先条件入力フィールド
- [x] 重視するポイント入力フィールド
- [x] 保存・キャンセルボタン
- [x] usePreferences hookをmobileで使用（または新規作成）

---

## 5. カテゴリ管理

### 5.1 カテゴリ作成
- [x] 「新規作成」ボタン追加
- [x] カテゴリ名入力フィールド
- [x] 12色カラーパレット選択UI
- [x] 作成・キャンセルボタン

### 5.2 カテゴリ削除
- [x] 各カテゴリに削除ボタン（×）追加
- [x] 削除確認ダイアログ

---

## 6. カレンダー管理

### 6.1 カレンダー表示設定
- [x] 各カレンダーに表示/非表示チェックボックス追加
- [x] 「すべて表示」ボタン

### 6.2 デフォルトカレンダー
- [x] 「デフォルトカレンダーを変更」ボタン
- [x] デフォルト選択UI

### 6.3 カレンダー作成
- [x] 「新しいカレンダーを作成」ボタン
- [x] カレンダー作成フォーム

---

## 7. プロフィール設定

### 7.1 メールアドレス更新
- [x] メールアドレス入力フィールド
- [x] 「メールアドレスを更新」ボタン
- [x] useProfile hookの更新機能を使用

### 7.2 Google連携
- [x] 「Googleアカウント連携」セクション追加
- [x] 「Googleアカウントを再設定」ボタン
- [x] expo-auth-sessionでGoogle OAuth実装

---

## 8. 予定検索機能

- [x] 予定検索モーダルの実装
- [x] キーワード入力フィールド
- [x] 日付範囲選択（開始日・終了日）
- [x] カテゴリフィルター（ボタングループ）
- [x] 検索・クリアボタン
- [x] 検索結果リスト表示
- [x] useScheduleSearch hookをmobileで使用

---

## 9. エラーハンドリング改善

- [x] 401エラー時の明示的なエラーメッセージ表示
- [x] ログイン画面へのリダイレクト処理

---

## 実装優先度（推奨）

### Phase 1: 基本機能の完成
1. メモ機能（1.1）
2. 繰り返し設定（1.2）
3. 予定詳細の完全表示（2.1, 2.2）
4. 予定検索機能（8）

### Phase 2: 管理機能
5. カテゴリ管理（5.1, 5.2）
6. カレンダー管理（6.1, 6.2, 6.3）
7. プロフィール設定（7.1）

### Phase 3: AI機能
8. こだわり条件設定（4）
9. AI検索機能（3.1, 3.2, 3.3）

### Phase 4: 認証強化
10. Google連携（7.2）
11. エラーハンドリング改善（9）

---

## 備考

- UI/UXの違い（モーダル表示スタイル、日時ピッカーなど）はモバイル最適化として維持
- FABは追加機能としてそのまま維持
- core/hooksの既存実装を最大限活用する

---

## テスト時に発見・修正したバグ

### Bug 1: メモ・AI結果が予定詳細に表示されない
- **原因**: `selectedSchedule.userMemo` / `selectedSchedule.aiSearchResult` を参照していたが、`Schedule` 型にはこれらのフィールドがない
- **修正**: `useQuery` で `fetchScheduleById` を使用し、`ScheduleWithSupplement` 型の `fullSchedule?.supplement?.userMemo` / `fullSchedule?.supplement?.aiResult` を参照するよう変更

### Bug 2: 繰り返し設定が表示されない
- **原因**: `selectedSchedule.recurrenceRule` を参照していたが、実際のフィールド名は `recurrence`
- **修正**: `selectedSchedule.recurrence` に変更

### Bug 3: こだわり条件（重視するポイント）が保存されない
- **原因**: `importantPoints` を使用していたが、APIスキーマでは `subjectiveConditions`
- **修正**: 全ての `importantPoints` を `subjectiveConditions` に変更

### Bug 4: メールアドレス更新が機能しない
- **原因**: `updateConditions({ email: editEmail.trim() } as any)` を使用していたが、`updateConditions` はプロフィール条件用で email フィールドを受け付けない
- **修正**: `useAuth` から `updateEmail` を取得し、`updateEmail(editEmail.trim())` を使用するよう変更
