# リファクタリング Phase 2 タスクリスト

基づくドキュメント:
- [extensible-review.md](./extensible-review.md) - 初回評価
- [extensibility-evaluation-20260110.md](./extensibility-evaluation-20260110.md) - 最新評価
- [tasks.md](./tasks.md) - Phase 1 完了済みタスク

---

## 完了済み（Phase 1）

| タスク | ステータス | 備考 |
|--------|-----------|------|
| TanStack Router導入 | ✅ 完了 | 認証ガード含む |
| useModalManager作成 | ✅ 完了 | **ただし未使用** |
| グローバルエラーハンドラ（Backend） | ✅ 完了 | app.onError実装済み |
| スキーマディレクトリ分割 | ✅ 完了（見送り） | 現規模では不要と判断 |

---

## 新規タスク（Phase 2）

### 優先度: 高

#### 1. useModalManager の MainApp 統合

**現状**: `useModalManager.ts` は作成済みだが `MainApp.tsx` では未使用。18個以上のuseStateが個別管理されている。

**タスク**:
- [ ] MainApp.tsx の現状のモーダル状態を洗い出し
- [ ] useModalManager を MainApp に導入
- [ ] 個別の useState を useModalManager に移行
- [ ] 関連コンポーネントの修正
- [ ] テスト確認

**期待効果**: MainApp.tsx を 390行 → 200行程度に削減

---

#### 2. テストDBスキーマ自動同期

**現状**: `schema.ts` と `test/helpers.ts` を手動で同期。スキーマ変更時にテストが失敗するリスク。

**タスク**:
- [ ] Drizzle の `generateSqliteSnapshot` または類似機能の調査
- [ ] `createTestDb` で schema.ts から DDL 自動生成する仕組みの実装
- [ ] 既存の手動 DDL を削除
- [ ] テスト実行で動作確認

**期待効果**: スキーマ変更時のテスト失敗リスク解消

---

#### 3. AI出力パーサー統一

**現状**: AI出力のJSON抽出・検証ロジックが分散。エラー耐性が低い。

**タスク**:
- [ ] 現在のAI出力解析箇所の洗い出し
- [ ] 共通パーサー関数 `parseAiOutput<T>` の設計
- [ ] JSON抽出、スキーマ検証、リトライロジックの統一実装
- [ ] 既存コードの置き換え
- [ ] テスト追加

**期待効果**: AI出力エラー時の耐性向上

---

### 優先度: 中

#### 4. 共通フォームコンポーネント作成

**現状**: フォーム要素（input, select等）が各コンポーネントで直接使用。スタイルやバリデーションが重複。

**タスク**:
- [ ] `components/common/` に追加するコンポーネント設計
  - [ ] Input.tsx
  - [ ] Select.tsx
  - [ ] FormField.tsx (Label + Input + Error)
- [ ] 既存コンポーネントで使用されているスタイルの統一
- [ ] ScheduleForm 等での置き換え（段階的）
- [ ] Storybook への追加

**期待効果**: フォーム追加時のボイラープレート削減

---

#### 5. フロントエンド エラーハンドリング統一

**現状**: エラーハンドリングが各フックで個別実装。パターンが統一されていない。

**タスク**:
- [ ] 現在のエラーハンドリングパターンの洗い出し
- [ ] `lib/errorHandler.ts` の設計
  - [ ] AppError 型定義
  - [ ] handleError 関数
  - [ ] useErrorHandler フック（オプション）
- [ ] 既存フックへの適用（useSchedules, useAI 等）
- [ ] エラー表示UIの統一

**期待効果**: エラー処理の一貫性向上、デバッグ容易化

---

#### 6. バックエンド try-catch 削減

**現状**: グローバルエラーハンドラは実装済みだが、各ルートに try-catch が残存。

**タスク**:
- [ ] 各ルートの try-catch 使用状況の確認
- [ ] AppException を throw するパターンへの移行
- [ ] 不要な try-catch の削除
- [ ] テスト確認

**期待効果**: ルートコードの簡潔化

---

### 優先度: 低（将来検討）

#### 7. Atomic Design 段階的移行

**現状**: コンポーネント粒度が粗い。再利用性が低い。

**タスク**:
- [ ] ディレクトリ構造の設計（atoms/molecules/organisms/features）
- [ ] Button, Modal を atoms に移動
- [ ] 新規コンポーネントから新構造を適用
- [ ] 既存コンポーネントの段階的リファクタリング

---

#### 8. コード生成ツール作成

**現状**: 新feature追加時のボイラープレートが多い。

**タスク**:
- [ ] テンプレートファイルの作成
  - [ ] Backend: route.ts, usecase, repo インターフェース
  - [ ] Frontend: hook, component
- [ ] 生成スクリプトの作成（plop または自作）

---

#### 9. DI Container 一元化（10+ feature 到達時）

**現状**: feature分散型DI。捨てやすさを優先している。

**判断基準**:
- feature数が10以上になった場合
- パターン変更が頻発する場合
- チーム規模が拡大した場合

---

## 進捗管理

| Phase | タスク | ステータス |
|-------|--------|-----------|
| 2-1 | useModalManager統合 | 未着手 |
| 2-2 | テストDBスキーマ自動同期 | 未着手 |
| 2-3 | AI出力パーサー統一 | 未着手 |
| 2-4 | 共通フォームコンポーネント | 未着手 |
| 2-5 | FEエラーハンドリング統一 | 未着手 |
| 2-6 | BE try-catch削減 | 未着手 |
| 2-7 | Atomic Design移行 | 将来検討 |
| 2-8 | コード生成ツール | 将来検討 |
| 2-9 | DI一元化 | 将来検討 |

---

## 推奨実施順序

```
1. useModalManager統合（高優先度・即効性あり）
   ↓
2. テストDBスキーマ自動同期（高優先度・信頼性向上）
   ↓
3. AI出力パーサー統一（高優先度・エラー耐性）
   ↓
4. 共通フォームコンポーネント（中優先度・並行可能）
   ↓
5. エラーハンドリング統一（中優先度・並行可能）
   ↓
6. try-catch削減（中優先度・並行可能）
```

4-6は独立しているため並行実施可能。
