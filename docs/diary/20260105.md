# 2026-01-05

## E2Eテストのデバッグ作業

今日は前回のセッションから引き継いで、E2Eテストの修正を続けた。前回の作業でいくつかのテストが`test.fixme()`でスキップされていた状態だったが、ユーザーから「バックエンドのコードも解析しながら詳細なデバッグを行ってほしい」という依頼を受けた。

### 問題の特定

最初に困ったのは、なぜテストが失敗しているのかが不明瞭だったこと。Playwrightのテストはタイムアウトするだけで、具体的なエラーメッセージが分かりにくかった。

デバッグ用のログ出力を追加して実行したところ、ブラウザコンソールに以下のエラーが出ていることが判明した：

```
Error: Invalid response format: [{"code": "invalid_type", "expected": "string", "received": "undefined", "path": ["endAt"], "message": "Required"}]
```

これで原因がはっきりした。モックのレスポンスで`endAt: body.endAt`としていたが、フォームから送られてくるデータには`endAt`が含まれていないため`undefined`になっていた。しかしZodスキーマは`endAt: z.string().nullable()`と定義されていたので、`undefined`は許容されず、`null`を返す必要があった。

### 学び

この問題は「モックのレスポンスがバックエンドの実際の動作と一致していない」という典型的なE2Eテストの落とし穴だった。バックエンドのコードとZodスキーマを照合することで正しいレスポンス形式が分かった。

また、Playwrightのルートパターン`**/api/schedules*`が`/api/schedules/schedule-1`にマッチしない（あるいは優先度の問題がある）ことも発見した。結局、ルートを3つに分離することで解決した：
- `**/api/schedules/*` - 詳細取得用
- `**/api/schedules?*` - 一覧取得用（クエリパラメータあり）
- `**/api/schedules` - 作成用

### 反省点

最初からブラウザコンソールのログを確認すべきだった。Playwrightの`page.on("console")`を使えばすぐにエラーの原因が分かったのに、何度もテストを実行して時間を無駄にしてしまった。

また、モックを書くときは必ず対応するZodスキーマを確認するべきだと改めて感じた。今回のように`nullable`と`optional`の違い（`null` vs `undefined`）でテストが失敗するケースは多い。

### 結果

最終的に全17テストが通過するようになった。達成感はあるが、デバッグに時間がかかりすぎた感もある。次回は最初から体系的にデバッグを進めたい。
