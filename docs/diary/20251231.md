# 2025-12-31 開発日記

## 今日やったこと

- 要件定義書（`docs/requirements.md`）をインタビュー形式で作成
- 設計書（`docs/design.md`）の作成
- 設計書を `docs/design/` 配下に分割（README.md, backend.md, frontend.md, infra.md）

## 感想

### インタビュー形式での要件定義が良かった

ユーザーが「インタビューする形で作っていこう」と言ってくれたおかげで、一方的に仕様を決めるのではなく、対話しながら要件を固められた。こちらから質問を投げて、ユーザーの意図を引き出していく形式は、認識のズレを防ぐのに効果的だと感じた。

### 技術選定の議論が建設的だった

ユーザーは技術に明るく、「Mastra Toolって何？Google APIと比較して教えて」のように、自分で調べて判断しようとする姿勢があった。こちらも調査結果を提示して、最終判断はユーザーに委ねる形で進められたのは良かった。

### クリーンアーキテクチャの設計で少し悩んだ

ユーザーが「classは使いたくない、関数型に寄せたい」と言ったとき、正直「Clean Architectureでclass使わないのは珍しいな」と思った。ただ、ファクトリ関数＋クロージャでDIを実現するパターンは、テストしやすさという点では確かに理にかなっている。結果的に良い設計になったと思う。

### 設計書の肥大化と分割

設計書が1000行を超えて肥大化したのは、正直もっと早く分割を提案すべきだった。ユーザーから「分割しようか」と言われる前に気づけなかったのは反省点。ドキュメントが大きくなりすぎると見通しが悪くなるのは自明なのに。

## 今後の懸念

- Mastra が Cloudflare Workers 上で本当に動くのか、実際に動かしてみないと分からない
- OpenRouter の `:online` variant の動作も、ドキュメントだけでは確信が持てない部分がある
- 設計書は書いたが、実装フェーズで「これ無理だった」となる可能性は常にある

## 良かった点

- ユーザーが決断力があり、議論が長引かなかった
- 技術的な提案を素直に受け入れてくれつつ、自分の意見もしっかり持っていた
- 「テキスト入力＋Markdown表示」のようなシンプルな解決策を選べたのは良い判断だった

---

## 午後: MVP実装完了

### 今日やったこと（午後）

- Phase 1〜5 の全タスクを実装
  - 環境構築（pnpm workspace, shared/backend/frontend パッケージ）
  - バックエンドAPI構築（Hono + Drizzle + Mastra）
  - ユニットテスト（Vitest, 10件全パス）
  - フロントエンド構築（React + Tailwind）
  - E2Eテストセットアップ（Playwright）
- インテグレーションテスト実施（ブラウザで実動作確認）
- バグ修正3件

### 感想

#### Zodのdatetime validationでハマった

一番時間を食ったのがZodの`datetime()`バリデーション。フォームからの日時が`2025-12-14T12:00:00+09:00`の形式なのに、Zodのデフォルトは`Z`終端のUTCしか受け付けない。`{ offset: true }`オプションが必要だと気づくまでに、ブラウザのsubmitボタンが効かない→ネットワークリクエストが飛ばない→なぜ？という迷路にはまった。

正直、このオプションの存在はZodのドキュメントを読み直して初めて思い出した。最初に実装したときに「日本のアプリだからJSTで来るよな」と想定して`offset: true`を入れておくべきだった。

#### ViteのプロキシでIPv6/IPv4問題

`localhost`だとIPv6（::1）に解決されて、IPv4でlistenしているバックエンドに繋がらなかった。これはWindows環境特有の問題かもしれない。`127.0.0.1`に明示的に書き換えて解決。こういう環境依存の問題は予測しづらい。

#### モックAIサービスは最初から入れておくべきだった

ユーザーに「AI通信部分、モックになってる？」と聞かれて「なってない」と気づいた。疎通確認の前にモックを用意しておくのは当然のことなのに、実装に集中するあまり忘れていた。ユーザーに指摘されなかったら、OpenRouterのAPIキーがない状態でデバッグする羽目になっていた。

#### Playwrightでのボタンクリックが効かなかった件

`button[type="submit"]`をクリックしてもフォームが送信されない現象があった。結局これはZodバリデーションでエラーになっていて、エラー表示のUIがなかったから「何も起きない」ように見えていた。バリデーションエラーの可視化は重要。

### 自己批判

- **エラーハンドリングのUI不足**: バリデーションエラーが出てもユーザーに何も表示されない箇所があった。フォームのタイトル欄だけはエラー表示があるが、datetime周りのエラーは握りつぶしていた。
- **テスト駆動できなかった**: 本来ならZodスキーマのテストを先に書いて、datetime形式の期待値を明確にしておけばハマらなかった。
- **コンテキストが途切れた影響**: 前回のセッションからの引き継ぎで、設計時の意図（日本時間で扱う）が薄れていた。

### 良かった点

- ユーザーが「全部動作確認して」と言ってくれたおかげで、机上の型チェックだけでは見つからないバグを発見できた
- PlaywrightのMCPツールでブラウザを直接操作してデバッグできたのは効率的だった
- モック実装のおかげで、AIのAPIキーなしでもフルフローが動作確認できる状態になった

### 今後の懸念

- 実際のOpenRouter APIを叩いたときに、レスポンス形式が想定と違う可能性がある
- `:online` variantの動作は未検証
- スケジュール編集・削除のUIがまだ実装されていない（handleScheduleEditがTODOのまま）
