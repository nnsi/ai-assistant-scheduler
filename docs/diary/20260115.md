# 2026-01-15

## 今日やったこと

- biome エラー修正（370件）
- mobile パッケージの TypeScript エラー修正
- pnpm monorepo での型チェック問題の解決

## 技術的な学び

### Response 型の最小化

React Native の `FormData` 型と標準の `FormData` 型が競合する問題に遭遇。core パッケージで `Response` 型を使っていたが、mobile から参照すると `formData()` の戻り値の型が合わずエラーになった。

解決策は `Response` を最小限の `ResponseLike` 型に変更すること：

```typescript
type ResponseLike = {
  ok: boolean;
  status: number;
  statusText: string;
  json: () => Promise<unknown>;
};
```

実際に使っているプロパティだけを定義することで、`formData()` などの環境依存メソッドの型競合を回避できた。

### pnpm workspace での型共有の難しさ

monorepo でソース（.ts）を直接共有していると、import 先のソースも型チェック対象になる。異なる環境（React Native vs Cloudflare Workers）のパッケージを共有する場合、環境固有の型が競合する問題が発生する。

解決策の選択肢：
1. 型を最小限に絞る（今回採用）
2. .d.ts を生成して共有（build が必要になる）
3. 型チェックから除外（型安全性が下がる）

## 反省点

最初に `ResponseLike` アプローチを提案したとき、ユーザーに「Response型を緩くしちゃダメじゃない？」と言われて引き下がった。しかし Codex に相談したら同じ結論に達した。

もう少し粘って説明すべきだった：
- これは内部関数の引数型であり、外部に公開される API ではない
- 実際に使っているプロパティだけを定義しているので、型安全性は損なわれない
- `Response` を要求すると、使わない `formData()` などのメソッドの型まで検証されてしまう

「型を緩くする」という表現が悪かった。「必要なプロパティだけを定義する」と言えばよかったかもしれない。

## 良かった点

- Codex への相談で別視点が得られた
- ユーザーの「typecheck前にbuildが必要なのは良くない」という指摘は的確だった。dist 生成の解決策は動いたが、運用面で問題があった
