# 2026-01-12

## E2Eテストの実API化

前回セッションからの継続で、E2Eテストをモックベースから実APIベースに移行する作業を完了した。

### やったこと

1. `index.ts`をファクトリ関数化（`createApp()`）
2. `e2e-server.ts`を簡素化し、`createApp()`を使う形に
3. `d1-adapter.ts`を作成してbetter-sqlite3をD1互換APIでラップ
4. スケジュール表示のテスト失敗を修正

### 反省点

**デバッグに時間がかかりすぎた**

「Schedule View/Edit/Delete」テストが失敗する原因を特定するのに、かなりの時間を費やした。様々な仮説を試した：
- React Queryのキャッシュ問題だと思った → 違った
- ページリロードで解決すると思った → 違った
- 再ログインで解決すると思った → 違った

実際の原因は**フロントエンドのカレンダーフィルタリング**だった。`calendarId: null`のスケジュールは、選択されたカレンダーでフィルタリングされて表示されなかった。

もっと早く`MainApp.tsx`の`filteredSchedules`ロジックを確認すべきだった。APIが正しくデータを返しているのに表示されないなら、レンダリング層の問題だと気づくべきだった。

**仮説検証の順序が悪かった**

1. バックエンド側の問題（API、認証）を疑った
2. React Queryのキャッシュを疑った
3. ようやくフロントエンドのフィルタリングを確認

正しい順序は：
1. APIが正しいデータを返しているか確認 ✓（早い段階で確認済み）
2. **データが返っているのに表示されない＝フロントエンドの問題**
3. フロントエンドのフィルタリング・レンダリングを確認

### 学び

- E2Eテストの失敗原因は、必ずしもバックエンドにあるわけではない
- 「APIは正しい、でも表示されない」→ フロントエンドのロジックを疑う
- スケジュールには`calendarId`が必要（フィルタリングで除外されるため）

### 成果

22個のE2Eテストが全てパス。実APIを使ったテストが約22秒で完了するようになった。モックを使わないことで、より本番に近い環境でのテストが可能になった。
